#!/bin/bash

# Rebuild and restart app services only (no DB/Redis).
# Usage:
#   ./easy_restart                # uses docker-compose.yml (rebuild api worker frontend admin)
#   ./easy_restart --alt-ports    # uses docker-compose.alt-ports.yml (rebuild api worker frontend)

set -e

# Determine compose command
if command -v docker-compose &> /dev/null; then
    BASE_CMD="docker-compose"
elif docker compose version &> /dev/null 2>&1; then
    BASE_CMD="docker compose"
else
    echo "Docker Compose not found. Install Docker Desktop or docker-compose." >&2
    exit 1
fi

# Select compose file and services
COMPOSE_FILE="docker-compose.yml"
SERVICES=(api worker frontend admin)

if [[ "$1" == "--alt" || "$1" == "--alt-ports" ]]; then
    COMPOSE_FILE="docker-compose.alt-ports.yml"
    SERVICES=(api worker frontend)
    shift
fi

COMPOSE_CMD=("$BASE_CMD" -f "$COMPOSE_FILE")

echo "ðŸ›  Rebuilding services (${SERVICES[*]}) using $COMPOSE_FILE..."
"${COMPOSE_CMD[@]}" build "${SERVICES[@]}"

echo "ðŸš€ Starting services without dependencies (DB/Redis unaffected)..."
"${COMPOSE_CMD[@]}" up -d --no-deps "${SERVICES[@]}"

echo "âœ… Done. Databases and Redis were not touched."


